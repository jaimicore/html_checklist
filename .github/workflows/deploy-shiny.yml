name: Deploy to shinyapps.io

on:
  push:
    branches:
      - main
    paths:
      - 'shiny_app/**'
      - 'checklist_helpers.R'
      - '.github/workflows/deploy-shiny.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.5.2'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev
      
      - name: Install R packages
        run: |
          R -e "install.packages(c('shiny', 'data.table', 'dplyr', 'DT', 'colourpicker', 'here', 'rsconnect'), repos='https://cloud.r-project.org/')"
      
      - name: Copy helper file to shiny_app directory
        run: |
          cp checklist_helpers.R shiny_app/checklist_helpers.R
      
      - name: Authorize and deploy to shinyapps.io
        env:
          SHINYAPPS_ACCOUNT: ${{ secrets.SHINYAPPS_ACCOUNT }}
          SHINYAPPS_TOKEN: ${{ secrets.SHINYAPPS_TOKEN }}
          SHINYAPPS_SECRET: ${{ secrets.SHINYAPPS_SECRET }}
        run: |
          R -e "
          rsconnect::setAccountInfo(
            name = Sys.getenv('SHINYAPPS_ACCOUNT'),
            token = Sys.getenv('SHINYAPPS_TOKEN'),
            secret = Sys.getenv('SHINYAPPS_SECRET')
          )
          rsconnect::deployApp(
            appDir = 'shiny_app',
            appName = 'html-checklist-generator',
            appTitle = 'HTML Checklist Generator',
            forceUpdate = TRUE,
            launch.browser = FALSE
          )
          "
      
      - name: Deployment complete
        run: |
          echo "App deployed successfully to https://${{ secrets.SHINYAPPS_ACCOUNT }}.shinyapps.io/html-checklist-generator/"
